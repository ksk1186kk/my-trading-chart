<!DOCTYPE html>
<html>
<head>
    <title>Trading Chart Fixed</title>
    <style>
        body { margin: 0; padding: 0; background-color: #1a1a1a; font-family: sans-serif; color: #ccc; }
        .chart-wrapper { position: relative; width: 100%; max-width: 900px; margin: 20px auto; }
        #main-chart { width: 100%; height: 400px; border: 1px solid #333; }
        #rsi-chart { width: 100%; height: 150px; margin-top: 5px; border: 1px solid #333; }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>

    <div class="chart-wrapper">
        <h2 style="text-align: center;">My Trading Chart</h2>
        <div id="main-chart"></div>
        <div id="rsi-chart"></div>
    </div>

    <script>
        // CRASH REPORTER: This will alert you if the code breaks
        window.onerror = function(message, source, lineno, colno, error) {
            alert("Error: " + message + "\nLine: " + lineno);
        };

        try {
            // --- 1. SETUP CHARTS ---
            const chartOptions = {
                layout: { textColor: '#d1d4dc', background: { type: 'solid', color: '#1a1a1a' } },
                grid: { vertLines: { color: '#2B2B43' }, horzLines: { color: '#2B2B43' } },
                timeScale: { borderColor: '#485c7b', timeVisible: true }
            };

            const mainChart = LightweightCharts.createChart(document.getElementById('main-chart'), chartOptions);
            const candleSeries = mainChart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            });
            const emaSeries = mainChart.addLineSeries({ color: '#2962FF', lineWidth: 2 });

            const rsiChart = LightweightCharts.createChart(document.getElementById('rsi-chart'), {
                ...chartOptions,
                timeScale: { visible: false }, 
            });
            const rsiSeries = rsiChart.addLineSeries({ color: '#ba68c8', lineWidth: 2 });
            
            // Static lines for RSI
            const overboughtLine = rsiChart.addLineSeries({ color: 'rgba(255, 255, 255, 0.3)', lineWidth: 1, lineStyle: 2 });
            const oversoldLine = rsiChart.addLineSeries({ color: 'rgba(255, 255, 255, 0.3)', lineWidth: 1, lineStyle: 2 });

            // --- 2. ROBUST DATA GENERATION ---
            function generateData(count = 200) {
                let data = [];
                // Start timestamp
                let time = Math.floor(Date.now() / 1000) - (count * 86400); 
                let value = 1000;
                
                for (let i = 0; i < count; i++) {
                    const change = (Math.random() - 0.5) * 10;
                    const open = value;
                    const close = value + change;
                    const high = Math.max(open, close) + Math.random() * 5;
                    const low = Math.min(open, close) - Math.random() * 5;
                    
                    data.push({ time: time, open, high, low, close });
                    time += 86400; 
                    value = close;
                }
                return data;
            }

            // EMA Math
            function calculateEMA(data, period) {
                const k = 2 / (period + 1);
                let emaData = [];
                // Simple Moving Average for first point
                let sum = 0;
                for(let i=0; i<period; i++) sum += data[i].close;
                let ema = sum / period;

                for (let i = period; i < data.length; i++) {
                    const price = data[i].close;
                    ema = price * k + ema * (1 - k);
                    emaData.push({ time: data[i].time, value: ema });
                }
                return emaData;
            }

            // RSI Math (Fixed for NaN errors)
            function calculateRSI(data, period = 14) {
                let rsiData = [];
                let gains = 0, losses = 0;

                for (let i = 1; i <= period; i++) {
                    const change = data[i].close - data[i - 1].close;
                    if (change > 0) gains += change;
                    else losses -= change;
                }

                let avgGain = gains / period;
                let avgLoss = losses / period;

                for (let i = period + 1; i < data.length; i++) {
                    const change = data[i].close - data[i - 1].close;
                    const gain = change > 0 ? change : 0;
                    const loss = change < 0 ? -change : 0;

                    avgGain = (avgGain * (period - 1) + gain) / period;
                    avgLoss = (avgLoss * (period - 1) + loss) / period;

                    let rs = avgLoss === 0 ? 100 : avgGain / avgLoss; // Safety Check
                    let rsi = 100 - (100 / (1 + rs));
                    
                    if (isNaN(rsi)) rsi = 50; // Final Safety Fallback

                    rsiData.push({ time: data[i].time, value: rsi });
                }
                return rsiData;
            }

            // --- 3. EXECUTE & RENDER ---
            const candles = generateData(300);
            const emaData = calculateEMA(candles, 20);
            const rsiData = calculateRSI(candles, 14);

            candleSeries.setData(candles);
            emaSeries.setData(emaData);
            rsiSeries.setData(rsiData);
            
            overboughtLine.setData(rsiData.map(d => ({ time: d.time, value: 70 })));
            oversoldLine.setData(rsiData.map(d => ({ time: d.time, value: 30 })));

            // Sync Charts (Check if method exists first)
            if (mainChart.timeScale().subscribeVisibleLogicalRangeChange) {
                mainChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                    rsiChart.timeScale().setVisibleLogicalRange(range);
                });
                rsiChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                    mainChart.timeScale().setVisibleLogicalRange(range);
                });
            }

            mainChart.timeScale().fitContent();
            
        } catch (err) {
            alert("Script Error: " + err.message);
        }
    </script>
</body>
</html>
